# MultiSector_LTS_Chile

Multisector model for Chile's Long-term Climate Strategy

## Running the Model

This model requires python 3.7+ and the following pacakges:

* math
* numpy
* os
* pandas
* pyDOE
* time
* shutil

The model can be run quickly using the following commands (assuming all requisite packages are installed and the correct version of python):

```bash
cd …/multisector_model/python
python experimental_design.py
python run_sector_models.py
```


## Input (D<b><u>A</u></b>M<b><u>I</u></b>)


The following sections detail mechanisms for both (1) setting up the model runtime session and (2) entering information about <b>Acciónes</b> and <b>Incertidumbres</b> into the emissions modeling framework. The first section, <b>Dimensions of Analysis</b>, discusses the dimensions of analysis and how to use attribute tables. The second section, <b>Parameter Inputs</b>, discusses how to enter (1) session parameters (used to stage the model runtime session) and (2) parameters trajectories for emissions models.

<br>

### Dimensions of Analysis

There are several dimensions of analysis (DAs) that represent different aspects of the DAMI matrix. Input to the models primarily includes <b>Acciónes</b> and <b>Incertidumbres</b> from the DAMI framework. The user enters data for four dimensions of analysis: <tt>design_id</tt>, <tt>future_id</tt>, <tt>time_series_id</tt>, and <tt>strategy_id</tt>.

#### Incertidumbre DAs

Uncertinty in the scripts is accounted for across three dimesions of analysis, including
* <tt>future_id</tt> (uncertainty <i>surrounding</i> projections),
* <tt>design_id</tt> (uncertainty in action or lever acheivment), and
* <tt>time_series_id</tt> (uncertainty <i>of</i> projections).

#### Acción DAs

Levers (acciónes) are represented in the dimension <tt>strategy_id</tt>.

#### Other DAs
Two different ids that are generated by the <tt>experimental_design.py</tt> script represent combinations of these:

* <tt>master_id</tt> is an identifer that represents unique combintaions of <tt>design_id</tt>, <tt>future_id</tt>, <tt>time_series_id</tt>, and <tt>strategy_id</tt>. This id field is the key for future scenarios and represents the full spectrum of acciónes and incertidumbres in the modeling framework.
* <tt>run_id</tt> is an identifer that represents unique combintaions of <tt>future_id</tt> and <tt>strategy_id</tt>.

<i><b>Note:</b> All id fields are entered as integers. Do not enter string or floating point values in these fields. </i>


#### Entering DAs

This section details each dimension of analysis and, if applicable, the format of associated attribute table. Dimensions of analysis shown below that are followed by a star are associated with attribute tables that are controlled by the user. Note that all user-controlled attribute tables are located in the <tt>ref</tt> subdirectory of <tt>MultiSector_LTS_Chile</tt>.


##### design_id

The DA <tt>design_id</tt> represents uncertainty in how closely actions are to achieving anticipated effect (D<b><u>A</u></b>M<b><u>I</u></b>). Uncertainty along this dimension is quantified for each strategy. To quantify it, the difference between an <b>accion</b> parameter under a non-baseline strategy and the baseline strategy is calcualted in <tt>experimental_design.py</tt> and is denoted as the <i>lever delta</i> (note that the baseline strategy is always entered as <tt>strategy_id = 0</tt> in the strategy attribute table--see below). The <tt>design_id</tt> allows the user to sample arund this effect and consider scenarios where a goal is not met or is exceeded.

The <tt>design_id</tt> attribute table is located at <tt>MultiSector_LTS_Chile/ref/attribute_design.csv</tt>. A brief description of input fields is included below. Note that fields that begin with <tt>linear_transform_ld_</tt> give parameter values for the linear transformation of LHS samples, which are then applied as scalars to lever deltas. Suppose LHS trials are x ~ U(0, 1). Then the transformation applied to generate scalars for lever deltas is $$d(x) = \max\{\min\{mx + b, a_1\}, a_0\}$$.

| field | description |
| ----- | ----------- |
| design_id | Integer index. 0 is baseline by convention. |
| vary_lever_deltas | Binary (1 or 0). A 1 indicates that this design will quantify uncertainty around the lever deltas, and a 0 will leave the lever delta fixed (for each strategy).|
| vary_uncertainties | Binary (1 or 0). A 1 indicates that this design will quantify uncertainty around incertidumbres (parameters of type incertidumbre), and a 0 will only assess fixed trajectories (no variation under futures).|
| linear_transform_ld_m | Real number, gives the value of $$m$$ in $$d(x)$$. |
| linear_transform_ld_b | Real number, gives the value of $$b$$ in $$d(x)$$. |
| min_lever_deltas | Real number, gives the value of $$a_0$$ in $$d(x)$$ |
| max_lever_deltas | Real number, gives the value of $$a_1$$ in $$d(x)$$ |
| Experimental Design | This field contains the name for the design. |
| include | Binary (1 or 0). A 1 indicates that this design will be included in the analysis, while a 0 indicates it will not be included.|



##### future_id

The DA <tt>future_id</tt> represents one component of future uncertainties (DAM<b><u>I</u></b>) and is associated with a LHS trial that modifies the base trajectory seen in <tt>ref/parameter_ranges.csv</tt>. This DA represents uncertainty <i>surrounding</i> base projections. The number of futures is controlled by the <tt>n_lhs</tt> session parameter that is specified in <tt>initialize_session.ini</tt>.

The user does not interact with the <tt>future_id</tt> directly. LHS samples associated with each <tt>future_id</tt> are stored in <tt>experimetnal_design/lhs_samples_multi_sector.csv</tt> and <tt>experimetnal_design/lhs_samples_levers.csv</tt> following execution <tt>experimental_design.py</tt>. Parameters that are generated for each <tt>master_id</tt> are stored in <tt>experimetnal_design/experimental_design_multi_sector.csv</tt>.


##### strategy_id

The DA <tt>stratgy_id</tt> represents actions (D<b><u>A</u></b>MI). Effects of each lever are implicitly defined using trajectories in the <tt>parameter_ranges.csv</tt> input file. Each parameter that is defined as an <b>accion</b> in the <tt>parameter_ranges.csv</tt> input file must be defined across all strategies that are included in the <tt>attribute_strategy.csv</tt> file. An example of how to define an <b>accion</b> parameter is detailed below in the <b>Parameter Input Example</b>.

Each strategy must be defined in the <tt>ref/attribute_strategy.csv</tt> attribute file, and it must be included for the strategy to run. The table below includes information about fields contained in the <tt>ref/attribute_strategy.csv</tt> attribute file. Note that additional fields can be added without affecting the modeling framework.

| field | description |
| ----- | ----------- |
| strategy_id | Integer index. 0 is baseline by convention. |
| strategy | Shorthand for strategy (English).|
| estrategia | Shorthand for strategy (Español).|
| strategy_name | Name of strategy (English). |
| include | Binary (1 or 0). A 1 indicates that this strategy will be included in the analysis, while a 0 indicates it will not be included.|


##### time_series_id

The DA <tt>time_series_id</tt> represents one component of future uncertainties (DAM<b><u>I</u></b>) and is associated with different future projection trajectoriees of parameter values in <tt>ref/parameter_ranges.csv</tt>. This DA represents uncertainty <i>of</i> base projections.

The DA <tt>time_series_id</tt> is a dimension of analysis that relates to different baseline trajectories. Each <tt>time_series_id</tt> represents a collection of projections to explore over using LHS. For example, in the Costa Rican model, <tt>time_series_id</tt> was used to connect different trajectories from the general equilibrium model (a base growth, low growth, and high growth). Each parameter, then, must have a value associated with each <tt>time_series_id</tt> that is included in the analysis, even if many will not vary under this dimension. Returning to the Costa Rican example, only parameters effected by the GEM model (including land use areas and projections of value added) varied under this DA.

Information about each possible time series collection must be defined in the <tt>ref/attribute_time_series.csv</tt> attribute file. The table below includes information about fields contained in the <tt>ref/attribute_time_series.csv</tt> attribute file. Note that additional fields can be added without affecting the modeling framework.

| field | description |
| ----- | ----------- |
| time_series_id | Integer index. 0 is baseline by convention. This is an index for a collection of projections. |
| time_series_name | Name (no specified language) of the time series collection.|
| time_series_description | Description of the set of projections.|

<br>

### Parameter Inputs

#### Session Parameters
All analyses should begin by setting a few session parameters in <tt>initialize_session.ini</tt>. A brief explanation of the parameters to specify here is included in the table below. Note that all parameters are entered <tt>param:    VALUE</tt>, where the colon and <tt>VALUE</tt> are tab-delimited.

| session parameter | description |
| ----- | ----------- |
| add_sec_variation_start_year | The first year where parameter trajectories diverge under <tt>future_id</tt> > 0--future scalars are applied to parameters in a slow fashion and start to "ramp up" to the true 2050 value beginning in this year. |
| model_years | Model years to save in the output files. All years must be entered with commas as delimiters and without spaces, e.g., <tt>2015,2018,2020</tt>. |
| n_lhs | The number of futures to run, governed by Latin Hypercube Sampling (LHS). LHS sampling is performed using the pyDOE package in python. |
| use_lu_diff_for_conv_q | Takes values of <b>True</b> or <b>False</b>. Setting this parameter to <b>True</b> will estimate deforestation to grassland and cropland as the difference between consecutive time steps. <b>False</b> allows for a specification of percentage of land use converted to grassland or cropland (deforestation). Default is <b>False</b>. |
| tar_base_name | Gives the basename of the output tarball created after each run. |


<hr>

#### Model Parameters

The primary input file for MultiSector_LTS_Chile is <tt>parameter_ranges.csv</tt>. Use this file to input the best estimate trajectory of each parameter for each combination of <tt>time_series_id</tt> and <tt>strategy_id</tt> that are included in the analysis (more information on these dimensions and how to include or exclude them is found below).

Parameters types include <b>accion</b> (levers - the accent has been omitted to ensure that character sets do not interfere with scripting) and <b>incertidumbre</b> (uncertainties). A summary of field values for every parameter entered in <tt>parameter_ranges.csv</tt> is shown below in Table 1. For more information on the dimensions of analysis (<tt>time_series_id</tt> and <tt>strategy_id</tt>), see below.

| field | description |
| ----- | ----------- |
| sector | Input the sector name here. This value is  currently used in <tt>run_sector_models.py</tt> to split dataframes into smaller subsets. |
| time_series_id | This is the id of the time series applicable to the row.  |
| strategy_id | This is the id of the strategy applicable to the row. |
| type | Should take value of <b>accion</b> or <b>incertidumbre</b>. All values denoted as <b>accion</b> will be treated as a lever when lever uncertainty is treated under different <tt>design_id</tt> values. In general, lever parameter trajetories vary under different strategies.|
| parameter | Parameter name for sampling. Note: names entered here will be transformed before being set as a field headers in <tt>experimental_design.csv</tt>. All parameters will be transformed to (1) be lower case and (2) replace white space with underscores.|
| normalize_group | This is a group designator used to ensure fractions sum to 1. Any parameters included in the same group will be normalized to sum to 1 after sampling occurs. For example, land use fractions are entered as a group. Groups should be integers, but do not have to be ordered. For example, 1 and 2 can be groups, and so can 1 and 8. However, "group_1" and "group_2" are invalid. |
| min_2050 | This is used to specify the minimum of the range of scalars to apply to the 2050 trajectory value (with a linear growth to this scalar occuring over time). For 2050 scalars distributed ~U(<i>a</i>, <i>b</i>), this gives <i>a</i>. |
| max_2050 | This is used to specify the maximum of the range of scalars to apply to the 2050 trajectory value (with a linear growth to this scalar occuring over time). For 2050 scalars distributed ~U(<i>a</i>, <i>b</i>), this gives <i>b</i>. |
| 2015..2050 (<i>y</i>) | Value of the parameter in year <i>y</i> for the given trajectory. |

To emphasize, while types of <b>accion</b> and <b>incertidumbre</b> are entered into <tt>parameter_ranges.csv</tt> in the same way, parameters of type <b>accion</b> are treated differently under different <tt>design_id</tt> values (the <tt>design_id</tt> dimesion is used to vary the ability to meet goals under different strategies) and should vary by strategy (they do not need to vary under all strategies; for example, some strategies may be cumulative and include portfolios of different alternatives). Paramaters of type <b>incertidumbre</b> should not vary by strategy. If a parameter is supposed to vary by <tt>strategy_id</tt>, they it should be entered as type <b>accion</b>.

##### Parameter Input Example

Suppose that an emissions factor under baseline might be constant at 10 kg/ha under strategy 0 (0 is always the baseline strategy by convention) from 2015 to 2050. Strategy 1, which represents a moderate decarbonization plan, might reduce this factor by a small amount every year until it reaches 7.5 kg/ha in 2050. Finally, suppose that Strategy 2 is a more aggressive strategy that reduces this factor until it is 5 kg/ha in 2050.

| sector | time_series_id | strategy_id | type | parameter | normalize_group | min_2050 | max_2050 | 2015 | ... | 2050 |
| --- | --- | --- | --- | --- | --- | --- | --- | --- | --- | --- |
| agriculture | 0 | 0 | accion | example_factor_kg-ha | | 0.8 | 1.2 | 10 | ... | 10 |

### Other Inputs

#### experimental_design_multi_sector_masters_to_run.csv
<tt>experimental_design_multi_sector_masters_to_run.csv</tt> is generated every time the experimental design is generated. By default, it includes <i>all</i> <tt>master_id</tt> values (all scenarios). However, this file can be modified to include any master ids. <i><b>Note:</b> <tt>run_sector_models.py</tt> will run only the <tt>master_id</tt> values contained in this file.</i>


## Output (<b><u>D</u></b>AMI)

There are two primary sets of output files generated in the modeling framework:

* Experimental design files and generated attribute tables for scenario keys, which are sent to </tt>multisector_model/experimental_design</tt>.
    * <tt>attribute_master.csv</tt> and <tt>attribute_runs.csv</tt> are generated by the <tt>experimental_design.py</tt> script. They vary by <tt>future_id</tt> and must be dynamically created by the scripts.
    * <tt>experimental_design_multi_sector_masters_to_run.csv</tt> is generated every time the experimental design is generated.
        * <i><b>Note:</b> if you intended to run a reduced set of scenarios as indexed by <tt>master_id</tt>, new <tt>master_id</tt> values representing the intended subset of runs will have to be entered here since the indexing of <tt>master_id</tt> may have changed.</i>
    * <tt>lhs_samples_###.csv</tt> contain raw LHS values for both modeling parameters (<tt>### = multi_sector</tt>) and levers (<tt>### = levers</tt>).
    * <tt>experimental_design_multi_sector.csv</tt> contain sampled parameter values across all <tt>master_id</tt> and years. Files with the suffix <tt>_diff</tt> include the deviation of <b>accion</b> parameters for each non-baseline strategy from the baseline strategy.
* Files that include designated <i>desempeños</i>, which are sent to <tt>multisector_model/out</tt>.

A brief discussion on these output files is included below.

### Experimental Design



## Description of Scripts

### experimental_design.py:
The script <tt>experimental_design.py</tt> is generates the experimental design that the model iterates over as well as several attribute tables . Several attribute files — located in the attribute folder — can be modified to include/exclude different scenarios associated with each uncertainty dimension.

The script <tt>experimental_design.py</tt> must . These scripts are kept separate in order to avoid generating a new experimental design each time the model is run. Note that there is no random seed currently set in experimental_design.py, so each time it is run, a new LHS matrix is generated. All files generated by experimental_design.py are stored in the experimental_design subdirectory.

          b. run_sector_models.py
              run_sector_models.py executes the models specified in each of the sector models scripts. All files generated by run_sector_models.py are stored in the out subdirectory.
              Run this script after running experimental_design.py.
  (3) The sector_model_#SECTOR#.py scripts include the basic sector models. For most of the models, the function takes df_in as an argument, where df_in is generally the master experimental design table (exported as experimental_design_multi_sector.csv).


### Output Files
multisector_model/experimental_design for all experimental design files
multisector_model/out for all model results files


### Team Wiki
The team wiki can be accessed [here](https://tinyurl.com/yxcmzfzr)
